"use strict";var v=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var u=Object.prototype.hasOwnProperty;var S=(o,s)=>{for(var a in s)v(o,a,{get:s[a],enumerable:!0})},A=(o,s,a,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of C(s))!u.call(o,n)&&n!==a&&v(o,n,{get:()=>s[n],enumerable:!(t=U(s,n))||t.enumerable});return o};var O=o=>A(v({},"__esModule",{value:!0}),o);var L={};S(L,{handler:()=>R});module.exports=O(L);var p=require("@aws-sdk/client-cognito-identity-provider"),m=require("@aws-sdk/client-dynamodb"),I=new m.DynamoDBClient({region:process.env.AWS_REGION}),N=new p.CognitoIdentityProviderClient({region:process.env.AWS_REGION}),w=process.env.SAMLPROXY_API_URL,b=60,E=async(o,s)=>{let a=await fetch(w,{method:"GET",cache:"no-cache",headers:{"Content-Type":"application/json",Authorization:s}});console.log("fetch samlurl res",a);let t=await a.json();console.log("fetch samlurl resData",t);let n=[];for(var r in t){console.log("samlslist getting item with id from ddb",t[r].id);let c={TableName:process.env.AMFA_SPINFO_TABLE,Key:{id:{S:`#SAML#${t[r].id}`}}},d=null;try{let i=await o.send(new m.GetItemCommand(c));console.log("samlslist get spInfo from dynamodb Res",i),i?.Item?.id&&(d={logoUrl:i?.Item?.logoUrl?.S,serviceUrl:i?.Item?.serviceUrl?.S,released:!!i?.Item?.released?.BOOL})}catch(i){console.log("samlslist get spInfo from dynamodb error",i)}n.push({id:t[r].id,name:t[r].name,entityId:t[r].entityId,logoUrl:d?.logoUrl,serviceUrl:d?.serviceUrl,released:d?.released})}return n},T=async(o,s)=>{let a={TableName:process.env.AMFA_SPINFO_TABLE,Key:{id:{S:`#OIDC#${s}`}}},t=null,n=[];try{let r=await o.send(new m.GetItemCommand(a));console.log("get spInfo from dynamodb Res",r),r?.Item?.id&&(t={logoUrl:r?.Item?.logoUrl?.S,serviceUrl:r?.Item?.serviceUrl?.S,released:r?.Item?.released?.BOOL})}catch(r){console.log("appclient get spInfo from dynamodb error",r)}if(t?.serviceUrl){try{n=JSON.parse(t.serviceUrl)}catch(r){console.log("appclient oidc spInfo serviceUrl json parse error",r)}delete t.serviceUrl,t.serviceProviders=n.filter(r=>r.released)}return t},R=async o=>{console.info(`EVENT
`+JSON.stringify(o,null,2));let s={type:"exception",message:"Service Error"},a=o.headers.authorization;try{let n={Limit:b,...o.body&&{NextToken:o.body},UserPoolId:process.env.USERPOOL_ID};console.info("params",n);let r=await N.send(new p.ListUserPoolClientsCommand(n)),c=[];if(r?.UserPoolClients&&r.UserPoolClients.length>0){let e=r.UserPoolClients.filter(l=>l.ClientName!=="hostedUIClient"&&l.ClientName!=="customAuthClient"&&l.ClientName!=="samlproxyClient"&&!l.ClientName.startsWith("amfasys_"));for(let l of e){let g=await T(I,l.ClientId);g&&g.serviceProviders.length>0&&c.push({id:l.ClientId,name:l.ClientName,logoUrl:g.logoUrl,serviceProviders:g.serviceProviders,type:"oidc"})}}(await E(I,a)).forEach(e=>{e.released&&c.push({id:e.id,name:e.name,logoUrl:e.logoUrl,serviceUrl:e.serviceUrl,released:e.released,type:"saml"})});let i=c.map(e=>(e.serviceProviders?.length===1&&(e.id=e.id+"#"+e.serviceProviders[0].spname.replace(/\s/g,""),e.name=e.serviceProviders[0].spname,e.released=e.serviceProviders[0].released,e.logoUrl=e.serviceProviders[0].splogourl?.length?e.serviceProviders[0].splogourl:e.logoUrl,e.serviceUrl=e.serviceProviders[0].sploginurl,delete e.serviceProviders),e)),y=parseInt(o.queryStringParameters.page),h=parseInt(o.queryStringParameters.perPage),f=(y-1)*h,P=i.length+f-1;return{statusCode:200,headers:{"Access-Control-Allow-Headers":"Content-Type,Authorization,X-Api-Key,Content-Range,X-Requested-With","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"OPTIONS,GET,POST","Access-Control-Expose-Headers":"Content-Range","Content-Range":`serviceproviders ${f}-${P}`},body:JSON.stringify({data:i,total:i.length})}}catch(n){switch(console.log("Catch an error: ",n),n.name){case"ThrottlingException":s={type:"exception",message:"Too many requests"};break;case"InvalidParameterValue":case"InvalidParameterException":s={type:"exception",message:"Invalid parameter"};break;default:s={type:"exception",message:"Service Error"};break}}return{statusCode:500,body:JSON.stringify(s)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
